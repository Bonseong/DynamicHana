<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dashboard.DashboardDAO">
	<resultMap type="dashboardVO" id="dashboardMap">
		<result column="compare_value" property="compareValue" />
		<result column="history_date" property="historyDate" />
		<result column="sub_total" property="subTotal" />
		<result column="sub_total_double" property="subTotalDouble" />
		<result column="cluster_no" property="clusterNo" />
		<result column="card_name" property="cardName" />
		<result column="this_month" property="thisMonth" />
		<result column="last_month" property="lastMonth" />

	</resultMap>

	<select id="selectTotalMember" resultType="dashboardVO"
		resultMap="dashboardMap">
		SELECT CNT, COMPARE_VALUE,
		ROUND((COMPARE_VALUE/CNT),4)*100
		AS RATIO FROM (
		SELECT COUNT(*) AS CNT FROM T_MEMBER),(
		SELECT COUNT(*)
		AS COMPARE_VALUE FROM T_MEMBER WHERE ENROLL_DATE BETWEEN
		TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE,-1)+1)-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD')
		AND TO_CHAR(TRUNC(LAST_DAY(ADD_MONTHS(SYSDATE, -1)))+1,'YYYY-MM-DD'))


	</select>

	<select id="selectTotalTransaction" resultType="dashboardVO"
		resultMap="dashboardMap">
		<![CDATA[
		SELECT CNT, COMPARE_VALUE,
    CASE WHEN CNT>=COMPARE_VALUE THEN ROUND((CNT-COMPARE_VALUE)/COMPARE_VALUE *100,2)
    WHEN  CNT<COMPARE_VALUE THEN ROUND((COMPARE_VALUE-CNT)/COMPARE_VALUE *100,2) END AS RATIO FROM (
SELECT COUNT(*) AS CNT FROM TRANSACTION_HISTORY WHERE HISTORY_DATE BETWEEN TO_CHAR(TRUNC(SYSDATE)) AND TO_CHAR(TRUNC(SYSDATE+1))),(
SELECT COUNT(*) AS COMPARE_VALUE FROM TRANSACTION_HISTORY WHERE HISTORY_DATE BETWEEN TO_CHAR(TRUNC(SYSDATE-1)) AND TO_CHAR(TRUNC(SYSDATE)))
		]]>


	</select>

	<select id="selectTotalAmount" resultType="dashboardVO"
		resultMap="dashboardMap">
		<![CDATA[
		SELECT CNT, COMPARE_VALUE,
    CASE WHEN CNT>=COMPARE_VALUE THEN ROUND((CNT-COMPARE_VALUE)/COMPARE_VALUE *100,2)
    WHEN  CNT<COMPARE_VALUE THEN ROUND((COMPARE_VALUE-CNT)/COMPARE_VALUE *100,2) END AS RATIO FROM (
SELECT SUM(AMOUNT) AS CNT FROM TRANSACTION_HISTORY WHERE HISTORY_DATE BETWEEN TO_CHAR(TRUNC(SYSDATE)) AND TO_CHAR(TRUNC(SYSDATE+1))),(
SELECT SUM(AMOUNT) AS COMPARE_VALUE FROM TRANSACTION_HISTORY WHERE HISTORY_DATE BETWEEN TO_CHAR(TRUNC(SYSDATE-1)) AND TO_CHAR(TRUNC(SYSDATE)))
		]]>


	</select>

	<select id="selectTotalCluster" resultType="dashboardVO"
		resultMap="dashboardMap">
		SELECT CNT, COMPARE_VALUE FROM(
		SELECT MAX(CLUSTER_NO) AS
		COMPARE_VALUE FROM PCA_COMPONENT WHERE PCA_DATE
		BETWEEN
		TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE,-1)+1)-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD')
		AND TO_CHAR(TRUNC(LAST_DAY(ADD_MONTHS(SYSDATE, -1))),'YYYY-MM-DD')),
		(SELECT MAX(CLUSTER_NO) AS CNT FROM PCA_COMPONENT WHERE PCA_DATE
		BETWEEN
		TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE,0)+1)-TO_CHAR(SYSDATE,'DD'),'YYYY-MM-DD')
		AND TO_CHAR(TRUNC(LAST_DAY(ADD_MONTHS(SYSDATE, 0))),'YYYY-MM-DD'))


	</select>

	<select id="selectWeelkyConsumption" resultType="list"
		resultMap="dashboardMap">

		SELECT HISTORY_DATE, SUM(AMOUNT) AS SUB_TOTAL FROM
		(SELECT
		TO_CHAR(TRUNC(HISTORY_DATE), 'MM-DD(DY)') AS HISTORY_DATE , AMOUNT
		FROM TRANSACTION_HISTORY WHERE HISTORY_DATE BETWEEN SYSDATE-7 AND
		SYSDATE) GROUP BY HISTORY_DATE ORDER BY HISTORY_DATE


	</select>

	<select id="selectMonthlyConsumption" resultType="list"
		resultMap="dashboardMap">
		<![CDATA[
		SELECT HISTORY_DATE, ROUND(SUM(AMOUNT),2) AS SUB_TOTAL_DOUBLE FROM(
SELECT TO_CHAR(TRUNC(HISTORY_DATE), 'MM')||'월' AS HISTORY_DATE, AMOUNT/10000000 AS AMOUNT  FROM TRANSACTION_HISTORY WHERE HISTORY_DATE >= TO_CHAR(ADD_MONTHS(SYSDATE, -5), 'YYYYMM') || '01'
AND HISTORY_DATE <= TO_CHAR(LAST_DAY(SYSDATE), 'YYYYMMDD')) GROUP BY HISTORY_DATE ORDER BY HISTORY_DATE
		]]>


	</select>

	<select id="selectMemberCluster" resultType="list"
		resultMap="dashboardMap">
		SELECT DECODE(CLUSTER_NO, 0, '무소속', CLUSTER_NO||'번 군집') AS
		CLUSTER_NO, CNT, NVL(CATEGORY,'일반 고객군') AS CATEGORY FROM(
		SELECT
		T1.CLUSTER_NO, T1.CNT, T2.CATEGORY FROM(
		SELECT CLUSTER_NO,
		COUNT(MEMBER_NO) AS CNT FROM PCA_MEMBER WHERE
		PCA_DATE='21/08/01' GROUP
		BY CLUSTER_NO ORDER BY CLUSTER_NO) T1,
		(SELECT DISTINCT CLUSTER_NO,
		LISTAGG(CATEGORY, ', ') WITHIN
		GROUP(ORDER BY CLUSTER_NO)
		OVER(PARTITION BY CLUSTER_NO) AS CATEGORY
		FROM PCA_COMPONENT WHERE
		PCA_DATE='21/08/01' ORDER BY CLUSTER_NO) T2
		WHERE T1.CLUSTER_NO =
		T2.CLUSTER_NO(+) ORDER BY CLUSTER_NO) ORDER BY
		CNT DESC


	</select>

	<select id="selectTopTenCard" resultType="list"
		resultMap="dashboardMap">
		<![CDATA[
SELECT CARD_NAME, LAST_MONTH, THIS_MONTH, LAST_MONTH + THIS_MONTH AS CNT, CASE WHEN LAST_MONTH>THIS_MONTH THEN ROUND((LAST_MONTH-THIS_MONTH)*100/DECODE(LAST_MONTH,0,NULL,LAST_MONTH),2) WHEN LAST_MONTH<THIS_MONTH THEN ROUND((THIS_MONTH-LAST_MONTH)*100/DECODE(LAST_MONTH,0,NULL,LAST_MONTH),2)  END AS RATIO
FROM(
SELECT CARD_NAME, SUM(LAST_MONTH) AS LAST_MONTH, SUM(THIS_MONTH) AS THIS_MONTH FROM(
SELECT CARD_NAME,
CASE WHEN
    ENROLL_CARD_DATE BETWEEN TRUNC(ADD_MONTHS(SYSDATE,-1), 'MM') AND LAST_DAY(ADD_MONTHS(SYSDATE,-1)) THEN 1
    ELSE 0
    END AS LAST_MONTH,
  CASE WHEN
    ENROLL_CARD_DATE BETWEEN TRUNC(ADD_MONTHS(SYSDATE,0), 'MM') AND LAST_DAY(ADD_MONTHS(SYSDATE,0)) THEN 1
    END AS THIS_MONTH  
    FROM(
SELECT C.CARD_NAME, M.ENROLL_CARD_DATE FROM CARD C, MEMBER_CARD M WHERE C.CARD_CODE = M.CARD_CODE)) GROUP BY CARD_NAME)  WHERE ROWNUM<=10 ORDER BY CNT DESC
		]]>

	</select>

	<select id="selectConsumptionTimeSlot" resultType="dashboardVO"
		resultMap="dashboardMap">
		<![CDATA[
SELECT MORNING, LUNCH, DINNER, NIGHT, (MORNING+LUNCH+DINNER+NIGHT) AS SUB_TOTAL FROM(
SELECT SUM(DECODE(HISTORY_DATE,'아침',1,0)) AS MORNING, SUM(DECODE(HISTORY_DATE,'점심',1,0)) AS LUNCH, SUM(DECODE(HISTORY_DATE,'저녁',1,0)) AS DINNER, SUM(DECODE(HISTORY_DATE,'야간',1,0)) AS NIGHT FROM(
SELECT CASE
WHEN HISTORY_TIME<'06:00' THEN '야간'
WHEN HISTORY_TIME<'12:00' THEN '아침'
WHEN HISTORY_TIME<'17:00' THEN '점심'
WHEN HISTORY_TIME<'21:00' THEN '저녁'
WHEN HISTORY_TIME<'24:00' THEN '야간'
END AS HISTORY_DATE
FROM TRANSACTION_HISTORY WHERE HISTORY_DATE BETWEEN TRUNC(ADD_MONTHS(SYSDATE,0), 'MM') AND LAST_DAY(ADD_MONTHS(SYSDATE,0))))
		]]>

	</select>




</mapper>